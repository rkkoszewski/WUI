<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Element Editor</title>
	<meta name="description" content="The HTML5 Herald">
	<meta name="author" content="SitePoint">

	<link rel="stylesheet" href="styles.css">
	<link rel="stylesheet" href="codemirror.css">
	
	<style>
		html, body, body > div{
			height: 100%;
			padding: 0;
			margin: 0;
		}
		
		.padding {
			box-sizing: border-box;
			padding: 16px;
		}
		
		.card-container:last-child {
			padding-right: 16px;
		}
		
		.card-container {
			padding: 16px 0 0 16px;
		}
	
		.horizontal, .editor, .preview_container{
			display: flex;
			width: 100%;
			flex: 1;
			flex-direction: column;
		}
		
		.vertical{
			display: flex;
			width: 100%;
			flex: 1;
		}
		
		.card{
			box-shadow: 0px 3px 1px -2px rgba(0, 0, 0, 0.2), 0px 2px 2px 0px rgba(0, 0, 0, 0.14), 0px 1px 5px 0px rgba(0, 0, 0, 0.12);
			margin-bottom: 16px;
			display: flex;
			flex-direction: column;
		}
		
		.card > h3{
			margin: 0;
			background-color: #607D8B;
			padding: 16px;
			color: white;
			transition: background-color 0.2s ease-in-out;
		}
		
		.card > h3.error{
			background-color: #8b6060;
		}

		.grow{
			flex-grow: 1;
		}
		
		.editor > .CodeMirror{
			width: 100%;
			height: 100%;
		}
		
		.preview_container{
			flex-grow: 1;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.data_element{
			padding-bottom: 6px;
			display: flex;
			font-weight: 900;
			padding-bottom: 16px;
		}
		
		.data_element:last-child{
			padding-bottom: 0;
		}
		
		.data_element > input{
			flex-grow: 1;
			margin-left: 16px;
		}
		
		.error_log{
			color: #ff8383;
			font-weight: 500;
			font-size: 12px;
		}
		
		
	</style>
	<style id="preview_style"></style>

	<!--[if lt IE 9]>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
	<![endif]-->
</head>

<body>
	<div class="vertical">
		<!-- General Styling and Design Column -->
		<div class="horizontal card-container"> <!-- Left  Side-->
			<div class="editor card"> <!-- HTML Editor-->
				<h3>HTML</h3>
				<textarea id="element_html"><div>
  <div class="label" wui-data="@text:label"></div>
  <div wui-data="@text:text"></div>
  <div wui-container="content"></div>
  <div class="container"></div>
</div></textarea>
			</div> 
			<div class="editor card"> <!-- HTML Editor-->
				<h3>CSS <span id="cssErrorLog" class="error_log"></span></h3>
				<textarea id="element_css">> div {
  box-shadow: 0px 4px 5px -2px rgba(0, 0, 0, 0.2), 0px 7px 10px 1px rgba(0, 0, 0, 0.14), 0px 2px 16px 1px rgba(0, 0, 0, 0.12);
  padding: 16px;
  border-radius: 3px;
  
  > .label{
  	font-weight: 900;
  }
}</textarea>
			</div> 
		</div> 
		<!-- Javascript Column -->
		<div class="horizontal card-container"> <!-- Left  Side-->
			<div class="editor card"> <!-- JS: Element Initialize Before added to DOM -->
				<h3>JS: Element-Initialize-Before <span id="jsElementInitializeBeforeErrorLog" class="error_log"></span></h3>
				<textarea id="element_initialize_before_js"></textarea>
			</div> 
			<div class="editor card"> <!-- JS: Element Initialize After added to DOM-->
				<h3>JS: Element-Initialize-After <span id="jsElementInitializeAfterErrorLog" class="error_log"></span></h3>
				<textarea id="element_initialize_after_js"></textarea>
			</div> 
			<div class="editor card"> <!-- JS: Element Set Data -->
				<h3>JS: Element-Set-Data <span id="jsSetDataErrorLog" class="error_log"></span></h3>
				<textarea id="element_set_data_js">node.querySelector(".label").innerText = data['label2']; 
setContainer("asd", node.querySelector(".container"));</textarea>
			</div> 
		</div> 
		<!-- Preview Column -->
		<div class="horizontal card-container">
			<div class="card grow"><!-- Preview Container -->
				<h3>PREVIEW</h3>
				<div class="preview_container padding"> <!-- Right Side -->
					<div class="preview" id="preview">PREVIEW</div>
				</div> 
			</div> 
			<!-- Data Container -->
			<div class="card">
				<h3>TEST DATA</h3>
				<div class="padding" id="testData">
					<div>test: <input type="text"/></div>
				</div>
			</div>
		</div>
	</div>
	
	<script>
		var data = {
			'label': 'Card Label',
			'label2': 'Card Label 2',
			'text': 'This is the card content. This can be dynamically changed as necesary. Isn\'t that great!?',
			'color': 'color:blue;'
		}
		
		// Element Object
		function WUIElement(definition, configuration = {}){
			// Correct Instantiation Guard
			if (!(this instanceof WUIElement)) 
				return new WUIElement(definition, debug);
			
			// Element Data and Metadata
			this.definition = definition;
			this.isWrapped = false;
			this._configuration = configuration;
			
			// WUI Element Debug: Enables some aditional audit data
			this._debug = (typeof configuration.debug !== 'undefined' ? configuration.debug : false);
			if(this._debug){
				this._debugAccessedData = {};
				this._debugCSSError;
			}
			
			this.node = this.createNode(); // Create Node
			this._renderCSS(); // Render CSS

			// Auto Data
			this.autoDataRefrences = {}; // Auto Data References
			this._parseAutoData(); // Parse Auto Data
			
			// Child Node Containers
			this.childNodeContainer = {};
			this._parseChildNodeContainers();
			// console.debug("POST CHILD NODE CONTAINER", this.childNodeContainer)
			
			// Export WUIElement instance in DOM Node
			this.node.WUIElement = this;
		}
		
		// WUIElement Prototypes
		WUIElement.prototype = {
			// Render CSS
			_renderCSS: function(force = false){
				var self = this;
				// Make Sure WUIEngine is Available
				if(typeof document.body.WUIEngine === 'undefined'){
					document.body.WUIEngine = {};
				}
				// Make Sure CSSCache is available in WUIEngine
				if(typeof document.body.WUIEngine.CSSCache === 'undefined'){
					document.body.WUIEngine.CSSCache = {};
				}
				// Fore Re-Render of CSS
				if(force){
					if(typeof document.body.WUIEngine.CSSCache[this.definition.name] !== 'undefined'){
						// console.log("REMOVING CSS NODE FOR RERENDERING");
						if(typeof document.body.WUIEngine.CSSCache[this.definition.name].styleNode !== 'undefined'){
							var styleNode = document.body.WUIEngine.CSSCache[this.definition.name].styleNode;
							styleNode.parentNode.removeChild(styleNode); // Remove Style DOM Node
						}
						delete document.body.WUIEngine.CSSCache[this.definition.name]; // Delete Cache Object
					}
				}
				
				// Create Style Element
				if(typeof document.body.WUIEngine.CSSCache[this.definition.name] === 'undefined'){
					if(typeof this.definition.css !== 'undefined'){ 
						// Create Style node
						var style = document.createElement('style'); 
						var elementUID = this.definition.name;
						
						// Render Style
						var format = (typeof this.definition.css.format !== 'undefined' ?  this.definition.css.format.toLowerCase() : '???');
						switch(format){
						case 'lesscss':
							// Create Style node
							console.log("CSS: RENDERING LESSCSS");
							less.render('.' + elementUID + (this.isWrapped ? '&' : '>') + '{' + this.definition.css.style + '}')
							.then(function(output) {
								// console.debug(output.css);
								style.innerHTML = output.css;
								if(self._debug && typeof self._configuration.debugCompileCSSSuccess === 'function'){
									self._configuration.debugCompileCSSSuccess(output.css, output.map, output.imports);
								}
								// output.css = string of css
								// output.map = string of sourcemap
								// output.imports = array of string filenames of the imports referenced
							},
							function(error) {
								console.error("ERROR: " + error);
								if(self._debug && typeof self._configuration.debugCompileCSSFail === 'function'){
									self._configuration.debugCompileCSSFail(error);
								}
							});
							break;
							
						default: // Defaults to regular CSS
							console.log("CSS: RENDERING REGULAR");
							style.innerHTML = this.definition.css.style;
						}
						
						// Cache Style
						document.body.WUIEngine.CSSCache[this.definition.name] = { 
							styleNode: style,
							uid: elementUID
						}; 
						document.head.appendChild(style); // Append style to DOM
						this.node.classList.add(document.body.WUIEngine.CSSCache[this.definition.name].uid);
					}else{
						// Non existent CSS
						document.body.WUIEngine.CSSCache[this.definition.name] = {};
						console.log("CSS: CSS NON EXISTENT");
					}
				}else{
					// Found already processed CSS
					if(typeof document.body.WUIEngine.CSSCache[this.definition.name].uid !== 'undefined'){
						this.node.classList.add(document.body.WUIEngine.CSSCache[this.definition.name].uid);
					}
				}
			},
			// Create DOM Node
			createNode: function(){
				var wrapper = document.createElement('div');
				wrapper.innerHTML = this.definition.html;
				if(wrapper.childNodes.length === 1 && false){ // No need for wrapper -> TODO: '&& false' always wrap due to wrong LESSCSS compiler when .class&div produces .classdiv instead of div.class. Remove this once it's fixed.
					var firstChild = wrapper.firstChild;
					if(firstChild.nodeType === Node.ELEMENT_NODE){
						// console.debug('Returning Non-Wrapped Node', firstChild);
						this.isWrapped = false;
						return firstChild; // Return non-wrapped node
					}
				}
				// console.debug('Returning Wrapped Node', wrapper);
				this.isWrapped = true;
				return wrapper;
			},
			// Call Element Definition Method Helper with AutoCompile
			_callMethod: function(definitionBranch, definitionLeafID, parameterDefinition, parameterData){
				var callback = definitionBranch[definitionLeafID];
				switch(typeof callback){
					case 'string': // Uncompiled State (Do compilation)
						callback = new Function(parameterDefinition, callback);
						definitionBranch[definitionLeafID] = callback; // Cache it for next time
						// 'break' left out intentionally to run the compiled function afterwards
					case 'function': // Compiled Function
						callback.apply(this, parameterData);
						break;
					default: // Handles 'undefined', null and unknown values
					// Do Nothing
				}	
			},
			// Data Access Debug
			_dataDebug: function(data){
				var self = this;
				return new Proxy(data, {
					get: function(obj, prop) {
						// console.debug("REQUESTING " + prop, obj)
						self._debugAccessedData[prop] = true; // Mark data as accessed
						return obj[prop];
				    }
				});
			},
			// Shared Data Parameters
			_dataParameters: function(){
				var self = this;
				return {
					definition: 'node, element, setContainer, performAction',
					parameters: [ // Default Elements: 'node, element, setContainer, performAction'
						this.node, // Element DOM Node
						this,  // Element Object
						function(id, node){ 
							var id = id.trim();
							if(id === '') throw 'Container ID Empty';
							if(typeof node === 'undefined' || node == null) throw 'Selected invalid Node';
							self._addChildNodeContainer(self, id, node); 
						}, // Set Container Node
						function(){ alert("ACTION PERFORMED") } // Action Performed Callback
					]
				}
			},
			// Initialize Element Before node is added to DOM
			initializeBefore: function(){
				var dataParameters = this._dataParameters();
				return this._callMethod(this.definition.js, 'initialize-before', dataParameters.definition, dataParameters.parameters);
			},
			// Initialize Element After node is added to DOM
			initializeAfter: function(){
				var dataParameters = this._dataParameters();
				return this._callMethod(this.definition.js, 'initialize-after', dataParameters.definition, dataParameters.parameters);
			},
			// Set Data (Call order: 2)
			setData: function(data){
				console.debug("THIS??", this)
				var dataParameters = this._dataParameters();
				dataParameters.definition += ', data';
				dataParameters.parameters.push(this._debug ? this._dataDebug(data) :data);
				return this._callMethod(this.definition.js, 'set-data', dataParameters.definition, dataParameters.parameters);
			},
			// Parse Auto Data Node
			_parseAutoDataNode: function(self, dnode){
				var data_content = dnode.getAttribute('wui-data'); // Get Data from wui-data attribute
				dnode.removeAttribute('wui-data'); // Remove the wui-data attribute from node
				// console.log("DATA CONTENT: "+data_content);

				data_content.split(',').forEach(function(data_value){
					var data_split_index = data_value.indexOf(':');
					if(data_split_index !== -1){
						var data_target = data_value.substring(0, data_split_index).trim();
						var data_id = data_value.substring(data_split_index + 1, data_value.length).trim();
						// console.debug("DATA TARGET: " +data_target + " / DATA ID: "+data_id);
	
							// Node References
							var ref = self.autoDataRefrences[data_id];
							if(typeof ref === 'undefined'){
								ref = self.autoDataRefrences[data_id] = {};
							}
							
							// Data Targets
							if(typeof ref[data_target] === 'undefined'){
								ref[data_target] = [];
							}
							
							ref[data_target].push(dnode);

							// Set Data
							self._setNodeAutoData(dnode, data, data_id, data_target);
					}else{
						console.error("INVALID ELEMENT DATA TYPE: " + data_value);
					}
				});
			},
			// Parse Auto Data
			_parseAutoData: function(){
				var self = this;
				// Find all Child nodes with wui-data attribute
				var wui_data_nodes = this.node.querySelectorAll('[wui-data]');
				wui_data_nodes.forEach(function(node){
					self._parseAutoDataNode(self, node);
				});
				// Check root node for wui-data attribute
				if(this.node.hasAttribute('wui-data')){
					this._parseAutoDataNode(this, this.node);
				}
			},
			// Set Node Auto Data
			_setNodeAutoData: function(tnode, data, data_id, data_target){
				data = this._debug ? this._dataDebug(data) : data;
				if(typeof data[data_id] !== 'undefined'){
					if(data_target.startsWith('@')){ // Pseudo Element
						// console.debug('Debug: Using Pseudo Element ' + data_target.substring(1));
						switch(data_target.substring(1)){
							case 'text': 
								tnode.innerText = data[data_id]; 
							break; // Set Text
							default: console.error('ERROR: Invalid Pseudo Element ' + data[data_id].substring(1));
						}
					}else{ // Raw Attribute
						// console.debug('Debug: Using Raw Element ' + data_target);
						tnode[data_target] = data[data_id];
					}
				}
			},
			// Set Auto Data (Call order: 1)
			setAutoData: function(data){
				var ref = this.autoDataRefrences;
				var self = this;
				Object.keys(ref).forEach(function(data_id) { // Iterate Data ID
					Object.keys(ref[data_id]).forEach(function(data_target) { // Iterate Data Target
						ref[data_id][data_target].forEach(function(dnode){
							self._setNodeAutoData(dnode, data, data_id, data_target);
						});
						// console.debug(data_target, ref[data_id][data_target]);
					});
				});
			},
			// Parse Child Node Containers
			_parseChildNodeContainers: function(){
				var self = this;
				// Find all Child nodes with wui-data attribute
				var wui_container_nodes = this.node.querySelectorAll('[wui-container]');
				wui_container_nodes.forEach(function(node){
					var containerID = node.getAttribute('wui-container');
					node.getAttribute('wui-container');
					self._addChildNodeContainer(self, containerID, node);
				});
				// Check root node for wui-data attribute
				if(this.node.hasAttribute('wui-container')){
					var containerID = this.node.getAttribute('wui-container');
					this.node.getAttribute('wui-container');
					this._addChildNodeContainer(this, containerID, this.node);
				}
			},
			// Add Child Node Container
			_addChildNodeContainer: function(self, id, node){
				// console.debug("ADDING CONTAINER WITH ID: " + id, node)
				self.childNodeContainer[id] = node;
			}
		}

		function buildTestDataElements(data, element, onInputCallback){
			var ref = element._debugAccessedData;
			var node = document.createElement('div');
			// console.debug(element.autoDataRefrences);
			
			Object.keys(ref).forEach(function(data_id) {
			
				var container = document.createElement('div');
				container.className = 'data_element';
				container.innerText = data_id + ': ';
				
				var dataInput = document.createElement('input');
				dataInput.type = 'text';
				dataInput.value = (typeof data[data_id] !== 'undefined' ? data[data_id] : '');
				dataInput.oninput = function(){
					data[data_id] = dataInput.value;
					onInputCallback();
				};
				container.appendChild(dataInput);
				
				node.appendChild(container);
			});

			// Append Node
			emptyNode(testData);
			testData.appendChild(node);
			return node;
		}
		
		function emptyNode(node){
			while (node.firstChild) {
				node.removeChild(node.firstChild);
			}
		}
	</script>
	
	<script src="codemirror-5.36.0/lib/codemirror.js"></script>
	<script src="codemirror-5.36.0/mode/xml/xml.js"></script>
	<script src="codemirror-5.36.0/mode/javascript/javascript.js"></script>
	<script src="codemirror-5.36.0/mode/css/css.js"></script>
	<script src="codemirror-5.36.0/mode/htmlmixed/htmlmixed.js"></script>
	<script src="codemirror-5.36.0/addon/edit/matchbrackets.js"></script>
	<script src="less.js"></script>
	<script src="scripts.js"></script>
	<script>
	var preview = document.getElementById('preview');
	var preview_css = document.getElementById('preview_style');
	var testData = document.getElementById('testData');
	var cssErrorLog = document.getElementById('cssErrorLog');
	
	var jsElementInitializeBeforeErrorLog = document.getElementById('jsElementInitializeBeforeErrorLog');
	var jsElementInitializeAfterErrorLog = document.getElementById('jsElementInitializeAfterErrorLog');
	var jsSetDataErrorLog = document.getElementById('jsSetDataErrorLog');
	
	// Current Element Definition
	var elementDefinition = {
		name: 'Example',
		version: '1.0.0',
		html: '',
		css: {
			format: 'lesscss',
			style: ''
		},
		js:{
			'initialize-before': '',
			'initialize-after': '',
			'set-data': ''
		},
		dependencies:{ // TODO: To be implementeds
			'jquery': '3.*'
		}
	}
	
	var preview_element;
	
	// Update Element Data
	function updateElement(){
		// console.debug("UPDATING ELEMENT DATA", preview.firstChild);
		preview_element.setAutoData(data); // Update Auto Data
		preview_element.setData(data); // Update Data
	}
	
	// Dummy Node
	function createDummyNode(id){
		var node = document.createElement('div');
		node.innerText = 'Dummy Node for ID: ' + id;
		node.style.backgroundColor = 'blue';
		node.style.color = 'yellow';
		node.style.padding = '3px';
		return node;
	}
	
	// Run Callback and Catch Error
	function runCatch(object, method, data, error_node){
		var parent = error_node.parentNode;
		try{
			object[method](data); 
			parent.classList.remove('error');
			error_node.innerText = '';
		}catch(e){
			console.error(e.stack);
			parent.classList.add('error');
			error_node.innerText = e;
		}
	}
	
	// Create Element (From Zero)
	function createElement(){
		emptyNode(preview);
		
		preview_element = new WUIElement(elementDefinition, { // Generate WUI Element
			debug: true,
			debugCompileCSSSuccess: function(){
				cssErrorLog.parentNode.classList.remove('error');
				cssErrorLog.innerText = '';
			},
			debugCompileCSSFail: function(error){
				cssErrorLog.parentNode.classList.add('error');
				cssErrorLog.innerText = error;
			}
		}); 
		runCatch(preview_element, 'initializeBefore', undefined, jsElementInitializeBeforeErrorLog); // Initialize Before
		preview.appendChild(preview_element.node); // Append Child Node
		runCatch(preview_element, 'initializeAfter', undefined, jsElementInitializeAfterErrorLog); // Initialize After
		preview_element.setAutoData(data); // Set Auto Data
		runCatch(preview_element, 'setData', data, jsSetDataErrorLog) // Set Data
		
		// Set Child Nodes
		console.debug("CHILD NODE CONTAINERS", preview_element.childNodeContainer);
		
		var childNodeContainer = preview_element.childNodeContainer;
		Object.keys(childNodeContainer).forEach(function(id) { // Iterate Child Node Containers
			childNodeContainer[id].appendChild(createDummyNode(id));
		});

		// Build Test Data Elements
		buildTestDataElements(data, preview_element, updateElement); // Build Test Data Editor
	}
	
	// HTML Editor
	var editor_html = CodeMirror.fromTextArea(document.getElementById('element_html'), {
		lineNumbers: true,
		mode: "text/html",
		matchBrackets: true,
		indentWithTabs: true,
		lineWrapping : true 
	});
	editor_html.on('change', function(editor, change){
		elementDefinition.html = editor.getValue(); // Set HTML Data
		createElement(); // Regenerate Element
	});
	elementDefinition.html = editor_html.getValue(); // Update Element Definition
	
	// CSS Editor
	var editor_css = CodeMirror.fromTextArea(document.getElementById('element_css'), {
		lineNumbers: true,
		mode: "text/css",
		matchBrackets: true,
		indentWithTabs: true,
		lineWrapping : true  
	});
	editor_css.on('change', function(editor, change){
		elementDefinition.css.style = editor.getValue();
		preview_element._renderCSS(true);
	});
	elementDefinition.css.style = editor_css.getValue(); // Update Element Definition
	
	// JS: Element Initialize Before
	var editor_initialize_before_js = CodeMirror.fromTextArea(document.getElementById('element_initialize_before_js'), {
		lineNumbers: true,
		mode: "text/javascript"
	});
	editor_initialize_before_js.on('change', function(editor, change){
		elementDefinition.js['initialize-before'] = editor.getValue();
		createElement();
	});
	elementDefinition.js['initialize-before'] = editor_initialize_before_js.getValue(); // Update Element Definition
	
	// JS: Element Initialize After
	var editor_initialize_after_js = CodeMirror.fromTextArea(document.getElementById('element_initialize_after_js'), {
		lineNumbers: true,
		mode: "text/javascript"
	});
	editor_initialize_after_js.on('change', function(editor, change){
		elementDefinition.js['initialize-after'] = editor.getValue();
		createElement();
	});
	elementDefinition.js['initialize-after'] = editor_initialize_after_js.getValue(); // Update Element Definition
	
	// JS: Element Set Data
	var editor_set_data_js = CodeMirror.fromTextArea(document.getElementById('element_set_data_js'), {
		lineNumbers: true,
		mode: "text/javascript"
	});
	editor_set_data_js.on('change', function(editor, change){
		elementDefinition.js['set-data'] = editor.getValue();
		createElement();
	});
	elementDefinition.js['set-data'] = editor_set_data_js.getValue(); // Update Element Definition

	// Initial Setup
	createElement();
	
	</script>
</body>
</html>