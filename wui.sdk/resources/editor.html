<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Element Editor</title>
	<meta name="description" content="The HTML5 Herald">
	<meta name="author" content="SitePoint">

	<link rel="stylesheet" href="styles.css">
	<link rel="stylesheet" href="codemirror.css">
	
	<style>
		html, body, body > div{
			height: 100%;
			padding: 0;
			margin: 0;
		}
		
		.padding {
			box-sizing: border-box;
			padding: 16px;
		}
		
		.card-container:last-child {
			padding-right: 16px;
		}
		
		.card-container {
			padding: 16px 0 0 16px;
		}
	
		.horizontal, .editor, .preview_container{
			display: flex;
			width: 100%;
			flex: 1;
			flex-direction: column;
		}
		
		.vertical{
			display: flex;
			width: 100%;
			flex: 1;
		}
		
		.card{
			box-shadow: 0px 3px 1px -2px rgba(0, 0, 0, 0.2), 0px 2px 2px 0px rgba(0, 0, 0, 0.14), 0px 1px 5px 0px rgba(0, 0, 0, 0.12);
			margin-bottom: 16px;
			display: flex;
			flex-direction: column;
		}
		
		.card > h3{
			margin: 0;
			background-color: #607D8B;
			padding: 16px;
			color: white;
			transition: background-color 0.2s ease-in-out;
		}
		
		.card > h3.error{
			background-color: #8b6060;
		}

		.grow{
			flex-grow: 1;
		}
		
		.editor > .CodeMirror{
			width: 100%;
			height: 100%;
		}
		
		.preview_container{
			flex-grow: 1;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.data_element{
			padding-bottom: 6px;
			display: flex;
			font-weight: 900;
			padding-bottom: 16px;
		}
		
		.data_element:last-child{
			padding-bottom: 0;
		}
		
		.data_element > input{
			flex-grow: 1;
			margin-left: 16px;
		}
		
		.error_log{
			color: #ff8383;
			font-weight: 500;
			font-size: 12px;
		}
		
		
	</style>
	<style id="preview_style"></style>

	<!--[if lt IE 9]>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
	<![endif]-->
</head>

<body>
	<div class="vertical">
		<!-- General Styling and Design Column -->
		<div class="horizontal card-container"> <!-- Left  Side-->
			<div class="editor card"> <!-- HTML Editor-->
				<h3>HTML</h3>
				<textarea id="element_html"><div>
  <div class="label" wui-data="@text:label"></div>
  <div wui-data="@text:text"></div>
  <div wui-container="content"></div>
  <div class="container"></div>
</div></textarea>
			</div> 
			<div class="editor card"> <!-- HTML Editor-->
				<h3>CSS <span id="cssErrorLog" class="error_log"></span></h3>
				<textarea id="element_css">> div {
  box-shadow: 0px 4px 5px -2px rgba(0, 0, 0, 0.2), 0px 7px 10px 1px rgba(0, 0, 0, 0.14), 0px 2px 16px 1px rgba(0, 0, 0, 0.12);
  padding: 16px;
  border-radius: 3px;
  
  > .label{
  	font-weight: 900;
  }
}</textarea>
			</div> 
		</div> 
		<!-- Javascript Column -->
		<div class="horizontal card-container"> <!-- Left  Side-->
			<div class="editor card"> <!-- JS: Element Initialize Before added to DOM -->
				<h3>JS: Element-Initialize-Before <span id="jsElementInitializeBeforeErrorLog" class="error_log"></span></h3>
				<textarea id="element_initialize_before_js"></textarea>
			</div> 
			<div class="editor card"> <!-- JS: Element Initialize After added to DOM-->
				<h3>JS: Element-Initialize-After <span id="jsElementInitializeAfterErrorLog" class="error_log"></span></h3>
				<textarea id="element_initialize_after_js"></textarea>
			</div> 
			<div class="editor card"> <!-- JS: Element Set Data -->
				<h3>JS: Element-Set-Data <span id="jsSetDataErrorLog" class="error_log"></span></h3>
				<textarea id="element_set_data_js">node.querySelector(".label").innerText = data['label2']; 
setContainer("asd", node.querySelector(".container"));</textarea>
			</div> 
		</div> 
		<!-- Preview Column -->
		<div class="horizontal card-container">
			<div class="card grow"><!-- Preview Container -->
				<h3>PREVIEW</h3>
				<div class="preview_container padding"> <!-- Right Side -->
					<div class="preview" id="preview">PREVIEW</div>
				</div> 
			</div> 
			<!-- Data Container -->
			<div class="card">
				<h3>TEST DATA</h3>
				<div class="padding" id="testData">
					<div>test: <input type="text"/></div>
				</div>
			</div>
		</div>
	</div>
	
	<script>
		var data = {
			'label': 'Card Label',
			'label2': 'Card Label 2',
			'text': 'This is the card content. This can be dynamically changed as necesary. Isn\'t that great!?',
			'color': 'color:blue;'
		}
		
		function buildTestDataElements(data, element, onInputCallback){
			var ref = element._debugAccessedData;
			var node = document.createElement('div');
			// console.debug(element.autoDataRefrences);
			
			Object.keys(ref).forEach(function(data_id) {
			
				var container = document.createElement('div');
				container.className = 'data_element';
				container.innerText = data_id + ': ';
				
				var dataInput = document.createElement('input');
				dataInput.type = 'text';
				dataInput.value = (typeof data[data_id] !== 'undefined' ? data[data_id] : '');
				dataInput.oninput = function(){
					data[data_id] = dataInput.value;
					onInputCallback();
				};
				container.appendChild(dataInput);
				
				node.appendChild(container);
			});

			// Append Node
			emptyNode(testData);
			testData.appendChild(node);
			return node;
		}
		
		function emptyNode(node){
			while (node.firstChild) {
				node.removeChild(node.firstChild);
			}
		}
	</script>
	
	<script src="codemirror-5.36.0/lib/codemirror.js"></script>
	<script src="codemirror-5.36.0/mode/xml/xml.js"></script>
	<script src="codemirror-5.36.0/mode/javascript/javascript.js"></script>
	<script src="codemirror-5.36.0/mode/css/css.js"></script>
	<script src="codemirror-5.36.0/mode/htmlmixed/htmlmixed.js"></script>
	<script src="codemirror-5.36.0/addon/edit/matchbrackets.js"></script>
	<script src="less.js"></script>
	<script src="wui.element.js"></script>
	<script src="wui.engine.js"></script>
	<script>
	var preview = document.getElementById('preview');
	var preview_css = document.getElementById('preview_style');
	var testData = document.getElementById('testData');
	var cssErrorLog = document.getElementById('cssErrorLog');
	
	var jsElementInitializeBeforeErrorLog = document.getElementById('jsElementInitializeBeforeErrorLog');
	var jsElementInitializeAfterErrorLog = document.getElementById('jsElementInitializeAfterErrorLog');
	var jsSetDataErrorLog = document.getElementById('jsSetDataErrorLog');
	
	// Current Element Definition
	var elementDefinition = {
		name: 'Example',
		version: '1.0.0',
		html: '',
		css: {
			format: 'lesscss',
			style: ''
		},
		js:{
			'initialize-before': '',
			'initialize-after': '',
			'set-data': ''
		},
		dependencies:{ // TODO: To be implementeds
			'jquery': '3.*'
		}
	}
	
	var preview_element;
	
	// Update Element Data
	function updateElement(){
		// console.debug("UPDATING ELEMENT DATA", preview.firstChild);
		preview_element.setAutoData(data); // Update Auto Data
		preview_element.setData(data); // Update Data
	}
	
	// Dummy Node
	function createDummyNode(id){
		var node = document.createElement('div');
		node.innerText = 'Dummy Node for ID: ' + id;
		node.style.backgroundColor = 'blue';
		node.style.color = 'yellow';
		node.style.padding = '3px';
		return node;
	}
	
	// Run Callback and Catch Error
	function runCatch(object, method, data, error_node){
		var parent = error_node.parentNode;
		try{
			object[method](data); 
			parent.classList.remove('error');
			error_node.innerText = '';
		}catch(e){
			console.error(e.stack);
			parent.classList.add('error');
			error_node.innerText = e;
		}
	}
	
	// Create Element (From Zero)
	function createElement(){
		emptyNode(preview);
		
		preview_element = new WUIElement(elementDefinition, { // Generate WUI Element
			data: data,
			debug: true,
			debugCompileCSSSuccess: function(){
				cssErrorLog.parentNode.classList.remove('error');
				cssErrorLog.innerText = '';
			},
			debugCompileCSSFail: function(error){
				cssErrorLog.parentNode.classList.add('error');
				cssErrorLog.innerText = error;
			}
		}); 
		runCatch(preview_element, 'initializeBefore', undefined, jsElementInitializeBeforeErrorLog); // Initialize Before
		preview.appendChild(preview_element.node); // Append Child Node
		runCatch(preview_element, 'initializeAfter', undefined, jsElementInitializeAfterErrorLog); // Initialize After
		// preview_element.setAutoData(data); // Set Auto Data
		runCatch(preview_element, 'setData', data, jsSetDataErrorLog) // Set Data
		
		// Set Child Nodes
		console.debug("CHILD NODE CONTAINERS", preview_element.childNodeContainer);
		
		var childNodeContainer = preview_element.childNodeContainer;
		Object.keys(childNodeContainer).forEach(function(id) { // Iterate Child Node Containers
			childNodeContainer[id].appendChild(createDummyNode(id));
		});

		// Build Test Data Elements
		buildTestDataElements(data, preview_element, updateElement); // Build Test Data Editor
	}
	
	// HTML Editor
	var editor_html = CodeMirror.fromTextArea(document.getElementById('element_html'), {
		lineNumbers: true,
		mode: "text/html",
		matchBrackets: true,
		indentWithTabs: true,
		lineWrapping : true 
	});
	editor_html.on('change', function(editor, change){
		elementDefinition.html = editor.getValue(); // Set HTML Data
		createElement(); // Regenerate Element
	});
	elementDefinition.html = editor_html.getValue(); // Update Element Definition
	
	// CSS Editor
	var editor_css = CodeMirror.fromTextArea(document.getElementById('element_css'), {
		lineNumbers: true,
		mode: "text/css",
		matchBrackets: true,
		indentWithTabs: true,
		lineWrapping : true  
	});
	editor_css.on('change', function(editor, change){
		elementDefinition.css.style = editor.getValue();
		preview_element._renderCSS(true);
	});
	elementDefinition.css.style = editor_css.getValue(); // Update Element Definition
	
	// JS: Element Initialize Before
	var editor_initialize_before_js = CodeMirror.fromTextArea(document.getElementById('element_initialize_before_js'), {
		lineNumbers: true,
		mode: "text/javascript"
	});
	editor_initialize_before_js.on('change', function(editor, change){
		elementDefinition.js['initialize-before'] = editor.getValue();
		createElement();
	});
	elementDefinition.js['initialize-before'] = editor_initialize_before_js.getValue(); // Update Element Definition
	
	// JS: Element Initialize After
	var editor_initialize_after_js = CodeMirror.fromTextArea(document.getElementById('element_initialize_after_js'), {
		lineNumbers: true,
		mode: "text/javascript"
	});
	editor_initialize_after_js.on('change', function(editor, change){
		elementDefinition.js['initialize-after'] = editor.getValue();
		createElement();
	});
	elementDefinition.js['initialize-after'] = editor_initialize_after_js.getValue(); // Update Element Definition
	
	// JS: Element Set Data
	var editor_set_data_js = CodeMirror.fromTextArea(document.getElementById('element_set_data_js'), {
		lineNumbers: true,
		mode: "text/javascript"
	});
	editor_set_data_js.on('change', function(editor, change){
		elementDefinition.js['set-data'] = editor.getValue();
		createElement();
	});
	elementDefinition.js['set-data'] = editor_set_data_js.getValue(); // Update Element Definition

	// Initial Setup
	createElement();
	
	</script>
</body>
</html>